apiVersion: apps/v1
kind: Deployment
metadata:
  name: craftique-backend
  namespace: default
  labels:
    # Standard Kubernetes labels
    app.kubernetes.io/name: craftique
    app.kubernetes.io/component: backend
    app.kubernetes.io/part-of: craftique-ecommerce
    app.kubernetes.io/managed-by: argocd
    app.kubernetes.io/version: "1.0.0"
    app.kubernetes.io/instance: craftique-default
    
    # Governance labels
    craftique.io/owner: platform-team
    craftique.io/environment: production
    craftique.io/cost-center: eng-backend
    craftique.io/criticality: critical
    craftique.io/data-classification: internal
    craftique.io/compliance: pci-dss
    
    # Operational labels
    craftique.io/backup-policy: daily
    craftique.io/monitoring: enabled
    craftique.io/public-facing: "true"
  annotations:
    # Supply Chain Security annotations
    supply-chain.craftique.io/signed: "true"
    supply-chain.craftique.io/signing-method: "cosign-keyless"
    supply-chain.craftique.io/provenance: "slsa-github-actions"
    
    # Operational annotations
    craftique.io/description: "Backend REST API service for Craftique e-commerce platform"
    craftique.io/repository: "https://github.com/Craft-Cart/Craftique"
    craftique.io/contact: "backend-team@craftique.io"
spec:
  replicas: 2
  selector:
    matchLabels:
      app: craftique-backend
  template:
    metadata:
      labels:
        app: craftique-backend
        app.kubernetes.io/name: craftique
        app.kubernetes.io/component: backend
        app.kubernetes.io/part-of: craftique-ecommerce
        app.kubernetes.io/version: "1.0.0"
        craftique.io/owner: platform-team
        craftique.io/environment: production
        craftique.io/cost-center: eng-backend
    spec:
      # Security: Run as non-root user (matches Dockerfile)
      securityContext:
        runAsUser: 1001
        runAsGroup: 1001
        fsGroup: 1001
        runAsNonRoot: true        # Enforce non-root execution
        seccompProfile:
          type: RuntimeDefault    # Use runtime default seccomp profile
      
      containers:
        - name: backend
          # Image is automatically updated by CI/CD pipeline with signed digest
          # Format: REGION-docker.pkg.dev/PROJECT_ID/REPO/IMAGE@sha256:DIGEST
          # DO NOT use :latest tags - they will be rejected by Kyverno policies
          image: us-central1-docker.pkg.dev/craftique-project/craftique/backend@sha256:PLACEHOLDER_UPDATED_BY_CICD
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 8000
          # Container-level security context (overrides pod-level for this container)
          securityContext:
            allowPrivilegeEscalation: false  # Prevent gaining more privileges
            readOnlyRootFilesystem: true     # Immutable root filesystem
            runAsNonRoot: true               # Enforce non-root user
            capabilities:
              drop:
                - ALL                        # Drop all capabilities
              add:
                - NET_BIND_SERVICE           # Only allow binding to privileged ports if needed
          env:
            - name: PORT
              value: "8000"
            # Database URL - Managed by External Secrets Operator
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: craftique-database-credentials
                  key: DATABASE_URL
            # Application secrets - Managed by External Secrets Operator
            - name: JWT_SECRET
              valueFrom:
                secretKeyRef:
                  name: craftique-backend-secrets
                  key: JWT_SECRET
            - name: COOKIE_SECRET
              valueFrom:
                secretKeyRef:
                  name: craftique-backend-secrets
                  key: COOKIE_SECRET
            - name: AUTH0_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: craftique-backend-secrets
                  key: AUTH0_CLIENT_SECRET
            - name: PAYMOB_API_KEY
              valueFrom:
                secretKeyRef:
                  name: craftique-backend-secrets
                  key: PAYMOB_API_KEY
            - name: PAYMOB_HMAC_SECRET
              valueFrom:
                secretKeyRef:
                  name: craftique-backend-secrets
                  key: PAYMOB_HMAC_SECRET
          # Volume mounts for writable directories (since root is read-only)
          volumeMounts:
            - name: tmp
              mountPath: /tmp
            - name: app-cache
              mountPath: /app/.cache
          resources:
            requests:
              memory: "128Mi"
              cpu: "100m"
            limits:
              memory: "256Mi"
              cpu: "300m"
      
      # Volumes for writable directories (readOnlyRootFilesystem requires this)
      volumes:
        - name: tmp
          emptyDir: {}
        - name: app-cache
          emptyDir: {}
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 30
            periodSeconds: 10
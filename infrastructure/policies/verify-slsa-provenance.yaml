# Kyverno ClusterPolicy: Verify SLSA Provenance
# This policy ensures images have valid SLSA provenance attestations
#
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: verify-slsa-provenance
  annotations:
    policies.kyverno.io/title: Verify SLSA Provenance
    policies.kyverno.io/category: Supply Chain Security
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Pod
    policies.kyverno.io/description: >-
      Verifies that container images have valid SLSA provenance attestations
      generated by GitHub Actions. This ensures images were built from our
      source repository using our CI/CD pipeline.
spec:
  validationFailureAction: Audit  # Start in audit mode, change to Enforce after testing
  background: true
  webhookTimeoutSeconds: 30
  rules:
    - name: verify-backend-provenance
      match:
        any:
          - resources:
              kinds:
                - Pod
              namespaces:
                - default
                - production
      verifyImages:
        - imageReferences:
            # GCP Artifact Registry pattern
            - "*-docker.pkg.dev/*/craftique/backend*"
            - "*-docker.pkg.dev/*/*/backend*"
          attestations:
            - type: https://slsa.dev/provenance/v1
              attestors:
                - entries:
                    - keyless:
                        subject: "https://github.com/*/.github/workflows/*"
                        issuer: "https://token.actions.githubusercontent.com"
                        rekor:
                          url: https://rekor.sigstore.dev
              conditions:
                - all:
                    # Verify the image was built from main/master branch
                    - key: "{{ buildDefinition.externalParameters.workflow.ref }}"
                      operator: AnyIn
                      value:
                        - "refs/heads/main"
                        - "refs/heads/master"

    - name: verify-frontend-provenance
      match:
        any:
          - resources:
              kinds:
                - Pod
              namespaces:
                - default
                - production
      verifyImages:
        - imageReferences:
            # GCP Artifact Registry pattern
            - "*-docker.pkg.dev/*/craftique/frontend*"
            - "*-docker.pkg.dev/*/*/frontend*"
          attestations:
            - type: https://slsa.dev/provenance/v1
              attestors:
                - entries:
                    - keyless:
                        subject: "https://github.com/*/.github/workflows/*"
                        issuer: "https://token.actions.githubusercontent.com"
                        rekor:
                          url: https://rekor.sigstore.dev
              conditions:
                - all:
                    - key: "{{ buildDefinition.externalParameters.workflow.ref }}"
                      operator: AnyIn
                      value:
                        - "refs/heads/main"
                        - "refs/heads/master"
                        - "refs/heads/master"
